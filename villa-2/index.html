<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8">
  <title>Murder Mystery Evaluator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --bg1:#171414;
      --bg2:#2a1c1c;
      --card:#000000;
      --accent:#c84b4b;
      --gold:#d4b46e;
      --muted:#b7a9a9;
      --panel:#3b2b2b;
    }
    html,body{
      height:100%;
      margin:0;
      font-family:"Segoe UI",system-ui,sans-serif;
      background:radial-gradient(circle at 10% 10%,var(--bg2),var(--bg1));
    }
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    .card{
      background:var(--card);
      padding:20px;
      border-radius:12px;
      color:var(--muted);
      box-shadow:0 10px 40px rgba(0,0,0,0.6);
    }
    h1{color:var(--gold)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px}
    .player-container{
      background:#fff;
      border-radius:16px;
      padding:14px;
      text-align:center;
    }
    .player-emoji{font-size:40px}
    .player-label{font-weight:bold;display:block;margin-bottom:6px}
    input{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:none;
      box-sizing:border-box;
    }
    button{
      background:var(--accent);
      border:none;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
    }
    .controls{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .result-player{
      margin-top:15px;
      border-radius:14px;
      padding:15px;
    }
    .result-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .result-cards div{
      margin-bottom:6px;
    }
    pre{
      background:#0d0b0b;
      color:#ddd;
      padding:10px;
      border-radius:8px;
      max-height:300px;
      overflow:auto;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <h1>ğŸ© Villa 2 Murder Mistery</h1>

    <div class="grid">
      <div class="player-container"><div class="player-emoji">ğŸˆâ€â¬›âš«</div><label id="label1" class="player-label">Petar</label><input id="p1"></div>
      <div class="player-container"><div class="player-emoji">ğŸ¥ğŸŸ¡</div><label id="label2" class="player-label">Igor</label><input id="p2"></div>
      <div class="player-container"><div class="player-emoji">ğŸ‹ğŸ”µ</div><label id="label3" class="player-label">Viktor</label><input id="p3"></div>
      <div class="player-container"><div class="player-emoji">ğŸ¦€ğŸ”´</div><label id="label4" class="player-label">Aleksandar</label><input id="p4"></div>
      <div class="player-container"><div class="player-emoji">ğŸğŸŸ¢</div><label id="label5" class="player-label">Damir</label><input id="p5"></div>
      <div class="player-container"><div class="player-emoji">ğŸ†ğŸŸ£</div><label id="label6" class="player-label">Oliver</label><input id="p6"></div>
      <div class="player-container"><div class="player-emoji">âš ï¸âš ï¸</div><label id="label7" class="player-label">Voditelj</label><input id="p7"></div>

      <!--<div class="player-container"><div class="player-emoji">ğŸ‘âšª</div><label id="label6" class="player-label">Player6</label><input id="p6"></div>
      <div class="player-container"><div class="player-emoji">ğŸ«ğŸŸ </div><label id="label7" class="player-label">Player7</label><input id="p7"></div>
      <div class="player-container"><div class="player-emoji">ğŸ·ğŸ©·</div><label id="label9" class="player-label">Player9</label><input id="p9"></div>-->
    </div>

    <div style="margin-top:10px">
      <label style="color:var(--gold)">Globalni brojevi</label>
      <input id="globalNumbers">
    </div>

    <div class="controls">
      <button id="evalBtn">âš–ï¸ Evaluiraj</button>
    </div>

    <h3 style="color:var(--gold)">Rezultati</h3>
    <div id="result"></div>

    <h4 style="color:var(--gold)">Debug</h4>
    <pre id="debug">â€”</pre>

  </div>
</div>

<script>
  async function loadGameFiles(){
    const [settingsRes, itemsRes, rulesRes] = await Promise.all([
      fetch("settings.json"),
      fetch("items.json"),
      fetch("rules.json")
    ]);
    return {
      settings: await settingsRes.json(),
      items: await itemsRes.json(),
      rules: await rulesRes.json()
    };
  }

  function getPlayers() {
    const playerInputs = document.querySelectorAll("[id^='p']"); // Select all elements with IDs starting with 'p'
    return Array.from(playerInputs).map(input => {
      const v = input.value.trim();
      return v ? v : null;
    });
  }

  function parseList(s){
    if(!s)return[];
    return s.split(',').map(x=>x.trim()).filter(x=>x);
  }

  function buildNumberMap(players,globals){
    const map={};
    players.forEach((v,i)=>{
      if(!v)return;
      v.split(',').forEach(n=>{
        n=n.trim();
        if(!map[n])map[n]=new Set();
        map[n].add(i);
      });
    });
    globals.forEach(g=>{
      if(!map[g])map[g]=new Set();
      players.forEach((v,i)=>{if(v)map[g].add(i);});
    });
    const out={};
    Object.keys(map).forEach(k=>out[k]=Array.from(map[k]));
    return out;
  }

  function setPlayerName(i,name){
    document.getElementById("label"+i).innerText=name;
  }

  function setPlayerColor(i,color){
    document.getElementsByClassName("player-container")[i-1].style.background=color;
  }

  function copyText(t){
    navigator.clipboard.writeText(t);
    alert("Copied!");
  }

  function replaceWinnerPlaceholder(text,winnerIdx){
    if(!winnerIdx)return text;
    const winnerName=document.getElementById("label"+winnerIdx).innerText;
    return text.replace(/\$\{winner\}/g,winnerName);
  }

  // makeEvaluator (same robust evaluator you provided)
  function makeEvaluator(condString) {
    let s = condString ? condString.replace(/\s+/g,' ').trim() : '';
    const numTokens = Array.from(new Set((s.match(/\b\d+\b/g) || [])));
    const playerTokens = Array.from(new Set((s.match(/\bp\d+\b/ig) || []).map(t=>t.toLowerCase())));
    const minMaxTokens = Array.from(new Set((s.match(/\b(min|max)\d+p\b/ig) || []).map(t=>t.toLowerCase())));

    return function evaluate(context){
      const playersCount = context.players.length;
      const numberMap = context.numberMap;
      const playersForNumber = {};
      numTokens.forEach(n => {
        playersForNumber[n] = (numberMap[n] || []).slice();
      });

      let combinedSet = new Set();
      numTokens.forEach(n => {
        (playersForNumber[n] || []).forEach(i => combinedSet.add(i));
      });
      const countCombined = combinedSet.size;

      const varMap = {};
      numTokens.forEach(n => varMap[n] = (playersForNumber[n] && playersForNumber[n].length>0));

      const players = context.players;
      playerTokens.forEach(pt => {
        const num = parseInt(pt.slice(1),10);
        const idx = num-1;
        if(numTokens.length>0){
          varMap[pt] = combinedSet.has(idx);
        } else {
          varMap[pt] = players[idx] !== null;
        }
      });

      minMaxTokens.forEach(tok => {
        const m = tok.match(/(min|max)(\d+)p/i);
        if(m){
          const typ = m[1].toLowerCase();
          const n = parseInt(m[2],10);
          if(typ === 'min') varMap[tok] = (countCombined >= n);
          else varMap[tok] = (countCombined <= n);
        }
      });

      let expr = s;
      expr = expr.replace(/\bNOT\b/ig, '!');
      expr = expr.replace(/\bAND\b/ig, '&&');
      expr = expr.replace(/\bOR\b/ig, '||');

      const allTokens = minMaxTokens.concat(playerTokens).concat(numTokens);
      allTokens.sort((a,b)=>b.length-a.length);

      allTokens.forEach(tok=>{
        const re = new RegExp('\\b' + tok.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\b', 'ig');
        const val = (tok in varMap) ? varMap[tok] : false;
        expr = expr.replace(re, val ? 'true' : 'false');
      });

      expr = expr.replace(/\bp\d+\b/ig, 'false');
      expr = expr.replace(/\b\d+\b/g, function(m){
        return (m in varMap && varMap[m]) ? 'true' : 'false';
      });

      expr = expr.replace(/\s+/g,' ');

      let passed = false;
      let evalError = null;
      try {
        passed = Function('"use strict"; return (' + expr + ');')();
      } catch(e){
        evalError = e.toString();
        passed = false;
      }

      let assigned = [];
      if(numTokens.length>0){
        assigned = Array.from(combinedSet).sort((a,b)=>a-b);
      } else if(playerTokens.length>0){
        assigned = playerTokens.map(pt => parseInt(pt.slice(1),10)-1).filter(i=>i>=0 && i<players.length);
      } else {
        assigned = players.map((v,i)=> v!==null ? i : -1).filter(i=>i>=0);
      }

      const notPlayerMatches = s.match(/\bNOT\s+p\d+\b/ig) || s.match(/\bnot\s+p\d+\b/ig) || [];
      notPlayerMatches.forEach(m=>{
        const p = m.match(/\d+/);
        if(p){
          const idx = parseInt(p[0],10)-1;
          assigned = assigned.filter(x=>x !== idx);
        }
      });

      const assignedPlayers = assigned.map(i => 'Player' + (i+1));

      return {
        passed,
        expr,
        evalError,
        numTokens,
        playerTokens,
        minMaxTokens,
        playersForNumber,
        combinedPlayers: Array.from(combinedSet),
        assignedPlayers
      };
    };
  }

  document.getElementById("evalBtn").addEventListener("click", async ()=>{

    const {settings, items, rules} = await loadGameFiles();

    const players=getPlayers();
    const globals=parseList(document.getElementById("globalNumbers").value);
    const numberMap=buildNumberMap(players,globals);
    console.log('numberMap:', JSON.stringify(numberMap, null, 2));

    const itemMap={};
    items.forEach(obj=>itemMap[obj.key]=obj);

    const playerCards={};
    players.forEach((v,i)=>{
      console.log("Player "+(i+1)+": "+v);
      playerCards["Player"+(i+1)]=[];
    });
    Object.keys(playerCards).forEach(p=>
            console.log(p + " = " +playerCards[p])
    )


    // SETTINGS
    settings.forEach(obj=>{
      for(let key in obj){
        if(key.startsWith("p")){
          const idx=parseInt(key.slice(1));
          setPlayerName(idx,obj[key]);
          if(obj.color)setPlayerColor(idx,obj.color);
        }
      }
    });

    let debugLines=[];
    // RULES
    const outputs = []; // {out:..., players: [...]}
    rules.forEach((r, idx) => {
      const cond = (r.cond || '').toString();
      const out = r.out || ('out_'+idx);
      const evaler = makeEvaluator(cond);
      const res = evaler({players, numberMap});
      debugLines.push(`Rule ${idx+1}: cond="${cond}" out="${out}"`);
      debugLines.push(' -> expr (after replace): ' + res.expr);
      if(res.evalError) debugLines.push(' -> eval error: ' + res.evalError);
      debugLines.push(' -> numTokens: ' + JSON.stringify(res.numTokens));
      debugLines.push(' -> playerTokens: ' + JSON.stringify(res.playerTokens));
      debugLines.push(' -> minMaxTokens: ' + JSON.stringify(res.minMaxTokens));
      debugLines.push(' -> playersForNumber: ' + JSON.stringify(res.playersForNumber));
      debugLines.push(' -> combinedPlayers: ' + JSON.stringify(res.combinedPlayers));
      debugLines.push(' -> passed: ' + res.passed);
      debugLines.push(' -> assigned players: ' + JSON.stringify(res.assignedPlayers));
      debugLines.push('');

      if(res.passed){
        outputs.push({out, players: res.assignedPlayers});
      }
    });
    console.log('outputs:', JSON.stringify(outputs, null, 2));

    outputs.forEach(({out, players}) => {
      const triggeredPlayers = players;

      if(triggeredPlayers.size===0)return;

      const eventObj=itemMap[out];
      if(!eventObj)return;

      // === EVENT TYPE ===
      if(eventObj.type==="event"){

        const involved=[...triggeredPlayers];

        let winnerIdx=null;

        if(eventObj.logic?.winnerStrategy==="priorityList"){
          const priority=eventObj.logic.priorityList;
          for(let p of priority){
            const idx=parseInt(p.slice(1))-1;
            if(involved.includes(idx)){
              winnerIdx=idx+1;
              break;
            }
          }
        }

        Object.keys(playerCards).forEach(p=>
        console.log(p + " = " +playerCards[p])
        )
        // winner text
        if(winnerIdx && eventObj.output.winner){
          console.log("Adding winner text to "+winnerIdx+": "+eventObj.output.winner);
          playerCards[winnerIdx].push(eventObj.output.winner);
        }

        // others text
        involved.forEach(involvedPlayer=>{
          if(involvedPlayer!==winnerIdx && eventObj.output.others){
            const txt=replaceWinnerPlaceholder(
                    eventObj.output.others,
                    winnerIdx
            );
            console.log("Adding others text to " + involvedPlayer+": "+txt);
            playerCards[involvedPlayer].push(txt);
          }
        });

        // specific player outputs (p3, p7, etc.)
        Object.keys(eventObj.output).forEach(key=>{
          if(key==="winner"||key==="others")return;
          if(key.startsWith("p")){
            const idx=parseInt(key.slice(1));
            if(playerCards["Player"+idx]){
              const txt=replaceWinnerPlaceholder(
                      eventObj.output[key],
                      winnerIdx
              );
              playerCards["Player"+idx].push(txt);
            }
          }
        });

      }else{
        Object.keys(playerCards).forEach(p=>
                console.log(p + " => " +JSON.stringify(playerCards[p]))
        )
        // obiÄni tekstualni item
        triggeredPlayers.forEach(playerName=>{
          console.log(playerName + " triggered!");
          playerCards[playerName]
                  .push(eventObj.value||out);
        });
      }
    });

    let html="";
    Object.keys(playerCards).forEach(p=>{
      if(playerCards[p].length===0)return;
      const text=playerCards[p].join("\n\n");
      const idx=parseInt(p.replace("Player",""));
      const name=document.getElementById("label"+idx).innerText;
      html+=`
    <div class="result-player" style="background:#ffffff">
      <div class="result-header">
        <strong>${name}</strong>
        <button onclick="copyText(\`${text}\`)">Copy</button>
      </div>
      <div class="result-cards">
        ${playerCards[p].map(c=>`<div>${c}</div>`).join("")}
      </div>
    </div>`;
    });

    document.getElementById("result").innerHTML=html||"Nema rezultata.";
    document.getElementById('debug').innerText = debugLines.join('\n');

  });
</script>
</body>
</html>
