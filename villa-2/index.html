<!doctype html>
<html lang="hr">
<head>
<meta charset="utf-8">
<title>Murder Mystery Evaluator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --bg1:#171414;
  --bg2:#2a1c1c;
  --card:#000000;
  --accent:#c84b4b;
  --gold:#d4b46e;
  --muted:#b7a9a9;
  --panel:#3b2b2b;
}
html,body{
  height:100%;
  margin:0;
  font-family:"Segoe UI",system-ui,sans-serif;
  background:radial-gradient(circle at 10% 10%,var(--bg2),var(--bg1));
}
.wrap{max-width:1100px;margin:28px auto;padding:20px}
.card{
  background:var(--card);
  padding:20px;
  border-radius:12px;
  color:var(--muted);
  box-shadow:0 10px 40px rgba(0,0,0,0.6);
}
h1{color:var(--gold)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px}
.player-container{
  background:#fff;
  border-radius:16px;
  padding:14px;
  text-align:center;
}
.player-emoji{font-size:40px}
.player-label{font-weight:bold;display:block;margin-bottom:6px}
input{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:none;
  box-sizing:border-box;
}
button{
  background:var(--accent);
  border:none;
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
.controls{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.result-player{
  margin-top:15px;
  border-radius:14px;
  padding:15px;
}
.result-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.result-cards div{
  margin-bottom:6px;
}
pre{
  background:#0d0b0b;
  color:#ddd;
  padding:10px;
  border-radius:8px;
  max-height:300px;
  overflow:auto;
}
</style>
</head>
<body>
<div class="wrap">
<div class="card">

<h1>ğŸ© Villa 2 Murder Mistery</h1>

<div class="grid">
  <div class="player-container"><div class="player-emoji">ğŸˆâ€â¬›âš«</div><label id="label1" class="player-label">Petar</label><input id="p1"></div>
  <div class="player-container"><div class="player-emoji">ğŸ¥ğŸŸ¡</div><label id="label2" class="player-label">Igor</label><input id="p2"></div>
  <div class="player-container"><div class="player-emoji">ğŸ‹ğŸ”µ</div><label id="label3" class="player-label">Viktor</label><input id="p3"></div>
  <div class="player-container"><div class="player-emoji">ğŸ¦€ğŸ”´</div><label id="label4" class="player-label">Aleksandar</label><input id="p4"></div>
  <div class="player-container"><div class="player-emoji">ğŸğŸŸ¢</div><label id="label5" class="player-label">Damir</label><input id="p5"></div>
  <div class="player-container"><div class="player-emoji">ğŸ†ğŸŸ£</div><label id="label6" class="player-label">Oliver</label><input id="p6"></div>
  <div class="player-container"><div class="player-emoji">âš ï¸âš ï¸</div><label id="label7" class="player-label">Voditelj</label><input id="p7"></div>
</div>

<div style="margin-top:10px">
<label style="color:var(--gold)">Globalni brojevi</label>
<input id="globalNumbers">
</div>

<div class="controls">
<button id="evalBtn">âš–ï¸ Evaluiraj</button>
</div>

<h3 style="color:var(--gold)">Rezultati</h3>
<div id="result"></div>

<h4 style="color:var(--gold)">Debug</h4>
<pre id="debug">â€”</pre>

</div>
</div>

<script>
async function loadGameFiles(){
  const [settingsRes, itemsRes, rulesRes] = await Promise.all([
    fetch("settings.json"),
    fetch("items.json"),
    fetch("rules.json")
  ]);
  return {
    settings: await settingsRes.json(),
    items: await itemsRes.json(),
    rules: await rulesRes.json()
  };
}

function getPlayers(){
  const arr=[];
  for(let i=1;i<=7;i++){
    const v=document.getElementById("p"+i).value.trim();
    arr.push(v? v : null);
  }
  return arr;
}

function parseList(s){
  if(!s)return[];
  return s.split(',').map(x=>x.trim()).filter(x=>x);
}

function buildNumberMap(players,globals){
  const map={};
  players.forEach((v,i)=>{
    if(!v)return;
    v.split(',').forEach(n=>{
      n=n.trim();
      if(!map[n])map[n]=new Set();
      map[n].add(i);
    });
  });
  globals.forEach(g=>{
    if(!map[g])map[g]=new Set();
    players.forEach((v,i)=>{if(v)map[g].add(i);});
  });
  const out={};
  Object.keys(map).forEach(k=>out[k]=Array.from(map[k]));
  return out;
}

function setPlayerName(i,name){
  document.getElementById("label"+i).innerText=name;
}

function setPlayerColor(i,color){
  document.getElementsByClassName("player-container")[i-1].style.background=color;
}

function copyText(t){
  navigator.clipboard.writeText(t);
  alert("Copied!");
}

// ğŸ”¥ PLACEHOLDER ENGINE
function resolvePlaceholders(text, currentPlayerIndex, itemKey, playerCards, listMap){

  const regex = /\$\{(.*?)\}/g;

  return text.replace(regex,(match,listName)=>{

    const list=listMap[listName];
    if(!list)return "";

    for(let entry of list){

      const idx=parseInt(entry.player.replace("p",""))-1;
      if(idx===currentPlayerIndex)continue;

      const playerKey="Player"+(idx+1);

      if(playerCards[playerKey] && playerCards[playerKey].includes(itemKey)){
        return entry.text;
      }
    }

    return "";

  });
}

document.getElementById("evalBtn").addEventListener("click", async ()=>{

  const {settings, items, rules} = await loadGameFiles();

  const players=getPlayers();
  const globals=parseList(document.getElementById("globalNumbers").value);
  const numberMap=buildNumberMap(players,globals);

  const cardMap={};
  const listMap={};

  // SETTINGS
  settings.forEach(obj=>{
    for(let key in obj){
      if(key.startsWith("p")){
        const idx=parseInt(key.slice(1));
        setPlayerName(idx,obj[key]);
        if(obj.color)setPlayerColor(idx,obj.color);
      }
    }
  });

  // ITEMS
  items.forEach(obj=>{
    if(obj.key){
      cardMap[obj.key]=obj.value;
    }
    if(obj.listName){
      listMap[obj.listName]=obj.entries;
    }
  });

  const playerCards={};
  players.forEach((v,i)=>{
    if(v!==null)playerCards["Player"+(i+1)]=[];
  });

  // RULES
  rules.forEach(r=>{
    const cond=r.cond;
    const out=r.out;
    const assigned=[];
    Object.keys(numberMap).forEach(n=>{
      if(cond.includes(n)){
        numberMap[n].forEach(i=>assigned.push("Player"+(i+1)));
      }
    });
    const unique=[...new Set(assigned)];
    unique.forEach(p=>{
      playerCards[p].push(out); // spremamo KEY
    });
  });

  let html="";
  Object.keys(playerCards).forEach(p=>{
    if(playerCards[p].length===0)return;

    const idx=parseInt(p.replace("Player",""));
    const name=document.getElementById("label"+idx).innerText;

    let finalTexts=[];

    playerCards[p].forEach(key=>{
      const raw=cardMap[key];
      if(raw){
        const resolved=resolvePlaceholders(raw,idx-1,key,playerCards,listMap);
        finalTexts.push(resolved);
      }else{
        finalTexts.push(key);
      }
    });

    const text=finalTexts.join("\n\n");

    html+=`
    <div class="result-player" style="background:#ffffff">
      <div class="result-header">
        <strong>${name}</strong>
        <button onclick="copyText(\`${text}\`)">Copy</button>
      </div>
      <div class="result-cards">
        ${finalTexts.map(c=>`<div>${c}</div>`).join("")}
      </div>
    </div>`;
  });

  document.getElementById("result").innerHTML=html||"Nema rezultata.";
  document.getElementById("debug").innerText=JSON.stringify(numberMap,null,2);

});
</script>
</body>
</html>
