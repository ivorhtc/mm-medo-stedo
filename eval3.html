<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8">
  <title>Murder Mystery Evaluator — Player1..Player7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg1: #171414;
      --bg2: #2a1c1c;
      --card: #2f2424;
      --accent: #c84b4b;
      --gold: #d4b46e;
      --muted: #b7a9a9;
      --panel: #3b2b2b;
      --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;padding:0;font-family: "Segoe UI", system-ui, sans-serif;background: radial-gradient(circle at 10% 10%, var(--bg2) 0%, var(--bg1) 60%);}
    .wrap{max-width:1000px;margin:28px auto;padding:20px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(0,0,0,0.6)}
    .card{background:var(--card);padding:20px;border-radius:12px;color:var(--muted);box-shadow:0 6px 24px rgba(0,0,0,0.5)}
    h1{margin:0 0 8px;color:var(--gold);font-size:1.6rem;letter-spacing:0.6px}
    p.lead{color:#e8ddd0;margin:6px 0 14px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    label{display:block;color:var(--gold);font-weight:600;margin-bottom:6px;font-size:0.95rem}
    input[type="text"], textarea {width:100%;box-sizing:border-box;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--panel);color:#fff}
    textarea{min-height:120px;resize:vertical}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{background:var(--accent);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    button.secondary{background:#4a3a3a}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
    .players-table{width:100%;margin-top:14px;border-collapse:collapse;background:transparent}
    .players-table th, .players-table td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);color:#fff}
    .players-table th{color:var(--gold);background:transparent}
    .out{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08));padding:12px;border-radius:8px;color:#fff;margin-top:10px;min-height:36px}
    pre#debug{background:#0d0b0b;color:#ddd;padding:12px;border-radius:8px;overflow:auto;margin-top:12px;max-height:320px}
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .small{font-size:0.9rem;color:var(--muted)}
    .file-input{display:none}
    .player-container {
      display: inline-block;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin: 10px;
      width: 150px;
      vertical-align: top;
    }

    .player-emoji {
      font-size: 50px;
      line-height: 1;
      display: block;
      margin-bottom: 8px;
    }

    .player-label {
      font-weight: bold;
      margin-bottom: 6px;
      display: block;
    }

    @media(max-width:880px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:520px){ .grid{grid-template-columns:1fr} .top-row{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top-row">
        <div>
          <h1>🎩 Murder Mystery Evaluator</h1>
          <p class="lead">Unesi igrače i pravila pa pritisni <b>Evaluiraj</b>. Rezultati su grupirani po listama igrača.</p>
        </div>
        <div class="small">Tip: koristi *min2p*, *p1*, *NOT p2*, numeričke tokene i logičke operatorе (AND/OR/NOT).</div>
      </div>

      <h3 style="color:var(--gold);margin-top:16px">Unesi vrijednosti igrača (po jedan broj u polje)</h3>
      <div class="grid" style="margin-bottom:10px">
        <div class="player-container">
          <span class="player-emoji">🐍🟢</span>
          <label class="player-label" for="p1">Player1</label>
          <input id="p1" type="text" placeholder="npr. 122">
        </div>
        <div class="player-container">
          <span class="player-emoji">🦀🔴</span>
          <label class="player-label" for="p2">Player2</label>
          <input id="p2" type="text" placeholder="npr. 150">
        </div>
        <div class="player-container">
          <span class="player-emoji">🐈‍⬛⚫</span>
          <label class="player-label" for="p3">Player3</label>
          <input id="p3" type="text" placeholder="npr. 122">
        </div>
        <div class="player-container">
          <span class="player-emoji">🐋🔵</span>
          <label class="player-label" for="p4">Player4</label>
          <input id="p4" type="text" placeholder="npr. 70">
        </div>
        <div class="player-container">
          <span class="player-emoji">🐥🟡</span>
          <label class="player-label" for="p5">Player5</label>
          <input id="p5" type="text" placeholder="npr. 33">
        </div>
        <div class="player-container">
          <span class="player-emoji">🐑⚪</span>
          <label class="player-label" for="p6">Player6</label>
          <input id="p6" type="text" placeholder="npr. 33">
        </div>
        <div class="player-container">
          <span class="player-emoji">🐫🟠</span>
          <label class="player-label" for="p7">Player7</label>
          <input id="p7" type="text" placeholder="npr. 33">
        </div>
        <div class="player-container">
          <span class="player-emoji">🍆🟣</span>
          <label class="player-label" for="p8">Player8</label>
          <input id="p8" type="text" placeholder="npr. 33">
        </div>
        <div class="player-container">
          <span class="player-emoji">🐷🩷</span>
          <label class="player-label" for="p9">Player9</label>
          <input id="p9" type="text" placeholder="npr. 33">
        </div>
        <div>
          <label>Globalni brojevi</label>
          <input id="globalNumbers" type="text" placeholder="npr. 10,200">
        </div>
      </div>

      <div class="controls">
        <button id="evalBtn">⚖️ Evaluiraj</button>
        <button id="saveBnt" onclick="saveToURL()" class="secondary">💾 Save URL</button>
        <button id="exportBtn" onclick="exportRules()" class="ghost">📤 Export Rules</button>
        <button id="importBtn" onclick="importRules()" class="ghost">📥 Import Rules</button>
        <input type="file" id="fileInput" class="file-input" accept=".json">
      </div>

      <h3 style="color:var(--gold);margin-top:18px">Rezultati</h3>
      <div id="result" class="out">Nema rezultata još.</div>

      <h3 style="color:var(--gold);margin-top:6px">Pravila (JSON array) — svako pravilo: {"cond":"...","out":"kod"}</h3>
      <textarea id="rules" rows="8">[
{"cond":"150","out":"300"},
{"cond":"min2p AND p1 AND 150","out":"301"},
{"cond":"min3p AND 150","out":"302"},
{"cond":"33","out":"401"},
{"cond":"33 NOT p2","out":"402"}
]</textarea>

      <h4 style="color:var(--gold);margin-top:12px">Detaljan debug (interni skupovi i evaluacije)</h4>
      <pre id="debug">—</pre>
    </div>
  </div>

<script>
(function(){
  // helpers
  const getPlayers = () => {
    const players = [];
    for (let i=1;i<=7;i++){
      const el = document.getElementById('p'+i);
      const v = el ? el.value.trim() : '';
      players.push(v === '' ? null : v);
    }
    return players;
  };
  const parseNumberList = s => {
    if(!s) return [];
    return s.split(',').map(x=>x.trim()).filter(x=>x!=='');
  };

  // Build map: number -> array of player indices (0-based)
  function buildNumberMap(players, globalNumbers){
    const map = {};
    players.forEach((val, idx) => {
      if (val === null) return;
      const vals = val.toString().split(',').map(x=>x.trim()).filter(x=>x!=='');
      vals.forEach(v=>{
        if(!map[v]) map[v] = new Set();
        map[v].add(idx);
      });
    });
    // Add global numbers: treat as if every present player also has them
    globalNumbers.forEach(g=>{
      if(!map[g]) map[g] = new Set();
      for(let i=0;i<players.length;i++){
        if(players[i] !== null) map[g].add(i);
      }
    });
    const out = {};
    for(const k in map) out[k] = Array.from(map[k]);
    return out;
  }

  // makeEvaluator (same robust evaluator you provided)
  function makeEvaluator(condString) {
    let s = condString ? condString.replace(/\s+/g,' ').trim() : '';
    const numTokens = Array.from(new Set((s.match(/\b\d+\b/g) || [])));
    const playerTokens = Array.from(new Set((s.match(/\bp\d+\b/ig) || []).map(t=>t.toLowerCase())));
    const minMaxTokens = Array.from(new Set((s.match(/\b(min|max)\d+p\b/ig) || []).map(t=>t.toLowerCase())));

    return function evaluate(context){
      const playersCount = context.players.length;
      const numberMap = context.numberMap;
      const playersForNumber = {};
      numTokens.forEach(n => {
        playersForNumber[n] = (numberMap[n] || []).slice();
      });

      let combinedSet = new Set();
      numTokens.forEach(n => {
        (playersForNumber[n] || []).forEach(i => combinedSet.add(i));
      });
      const countCombined = combinedSet.size;

      const varMap = {};
      numTokens.forEach(n => varMap[n] = (playersForNumber[n] && playersForNumber[n].length>0));

      const players = context.players;
      playerTokens.forEach(pt => {
        const num = parseInt(pt.slice(1),10);
        const idx = num-1;
        if(numTokens.length>0){
          varMap[pt] = combinedSet.has(idx);
        } else {
          varMap[pt] = players[idx] !== null;
        }
      });

      minMaxTokens.forEach(tok => {
        const m = tok.match(/(min|max)(\d+)p/i);
        if(m){
          const typ = m[1].toLowerCase();
          const n = parseInt(m[2],10);
          if(typ === 'min') varMap[tok] = (countCombined >= n);
          else varMap[tok] = (countCombined <= n);
        }
      });

      let expr = s;
      expr = expr.replace(/\bNOT\b/ig, '!');
      expr = expr.replace(/\bAND\b/ig, '&&');
      expr = expr.replace(/\bOR\b/ig, '||');

      const allTokens = minMaxTokens.concat(playerTokens).concat(numTokens);
      allTokens.sort((a,b)=>b.length-a.length);

      allTokens.forEach(tok=>{
        const re = new RegExp('\\b' + tok.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\b', 'ig');
        const val = (tok in varMap) ? varMap[tok] : false;
        expr = expr.replace(re, val ? 'true' : 'false');
      });

      expr = expr.replace(/\bp\d+\b/ig, 'false');
      expr = expr.replace(/\b\d+\b/g, function(m){
        return (m in varMap && varMap[m]) ? 'true' : 'false';
      });

      expr = expr.replace(/\s+/g,' ');

      let passed = false;
      let evalError = null;
      try {
        passed = Function('"use strict"; return (' + expr + ');')();
      } catch(e){
        evalError = e.toString();
        passed = false;
      }

      let assigned = [];
      if(numTokens.length>0){
        assigned = Array.from(combinedSet).sort((a,b)=>a-b);
      } else if(playerTokens.length>0){
        assigned = playerTokens.map(pt => parseInt(pt.slice(1),10)-1).filter(i=>i>=0 && i<players.length);
      } else {
        assigned = players.map((v,i)=> v!==null ? i : -1).filter(i=>i>=0);
      }

      const notPlayerMatches = s.match(/\bNOT\s+p\d+\b/ig) || s.match(/\bnot\s+p\d+\b/ig) || [];
      notPlayerMatches.forEach(m=>{
        const p = m.match(/\d+/);
        if(p){
          const idx = parseInt(p[0],10)-1;
          assigned = assigned.filter(x=>x !== idx);
        }
      });

      const assignedPlayers = assigned.map(i => 'Player' + (i+1));

      return {
        passed,
        expr,
        evalError,
        numTokens,
        playerTokens,
        minMaxTokens,
        playersForNumber,
        combinedPlayers: Array.from(combinedSet),
        assignedPlayers
      };
    };
  }

  // Main evaluate action
  document.getElementById('evalBtn').addEventListener('click', () => {
    const players = getPlayers();
    const globalNumbers = parseNumberList(document.getElementById('globalNumbers').value);
    const numberMap = buildNumberMap(players, globalNumbers);

    let rules;
    try {
      rules = JSON.parse(document.getElementById('rules').value);
      if(!Array.isArray(rules)) throw 'Rules must be JSON array';
    } catch(e){
      document.getElementById('result').innerText = 'Greška pri parsiranju pravila JSON: ' + e;
      return;
    }

    const debugLines = [];
    debugLines.push('Players raw: ' + JSON.stringify(players));
    debugLines.push('Global numbers: ' + JSON.stringify(globalNumbers));
    debugLines.push('Number map (number -> playerIndices): ' + JSON.stringify(numberMap));
    debugLines.push('');

    const outputs = []; // {out:..., players: [...]}
    rules.forEach((r, idx) => {
      const cond = (r.cond || '').toString();
      const out = r.out || ('out_'+idx);
      const evaler = makeEvaluator(cond);
      const res = evaler({players, numberMap});
      debugLines.push(`Rule ${idx+1}: cond="${cond}" out="${out}"`);
      debugLines.push(' -> expr (after replace): ' + res.expr);
      if(res.evalError) debugLines.push(' -> eval error: ' + res.evalError);
      debugLines.push(' -> numTokens: ' + JSON.stringify(res.numTokens));
      debugLines.push(' -> playerTokens: ' + JSON.stringify(res.playerTokens));
      debugLines.push(' -> minMaxTokens: ' + JSON.stringify(res.minMaxTokens));
      debugLines.push(' -> playersForNumber: ' + JSON.stringify(res.playersForNumber));
      debugLines.push(' -> combinedPlayers: ' + JSON.stringify(res.combinedPlayers));
      debugLines.push(' -> passed: ' + res.passed);
      debugLines.push(' -> assigned players: ' + JSON.stringify(res.assignedPlayers));
      debugLines.push('');

      if(res.passed){
        outputs.push({out, players: res.assignedPlayers});
      }
    });

    // GROUP BY player-list (so [p1,p2] -> codes)
    // Create map: key = JSON.stringify(sorted players), val = set of outs
    const groupMap = new Map();
    outputs.forEach(o=>{
      // sort players to have consistent key
      const key = JSON.stringify(o.players.slice().sort());
      if(!groupMap.has(key)) groupMap.set(key, new Set());
      groupMap.get(key).add(o.out);
    });

    const playerIcons = {
      "Player1": "🟢",
      "Player2": "🔴",
      "Player3": "⚫",
      "Player4": "🔵",
      "Player5": "🟡",
      "Player6": "⚪",
      "Player7": "🟠",
      "Player8": "🟣",
      "Player9": "🩷",
    };

    
    // Build human-friendly result
    if(groupMap.size === 0){
      document.getElementById('result').innerText = 'Nijedno pravilo nije prošlo.';
    } else {
      const lines = [];
      for(const [key, outsSet] of groupMap.entries()){
        const playersList = JSON.parse(key);
        const outs = Array.from(outsSet);
        var line = `[${playersList.join(', ')}] → ${outs.join(', ')}`;
        line = line.replace(/Player\d+/g, match => playerIcons[match] || match);
        lines.push(line);
      }
      document.getElementById('result').innerHTML = lines.map(l=>`<div>${l}</div>`).join('');
    }

    document.getElementById('debug').innerText = debugLines.join('\n');
  });

  document.getElementById('saveBtn').addEventListener('click', () => {
    saveToURL();
  });

  document.getElementById('importBtn').addEventListener('click', () => {
    importRules();
  });

  document.getElementById('exportBtn').addEventListener('click', () => {
    exportRules();
  });


  // Save to URL (copy)
  function saveToURL(){
    const params = new URLSearchParams();
    // players
    for(let i=1;i<=7;i++){
      const v = document.getElementById('p'+i).value.trim();
      if(v) params.set('p'+i, v);
    }
    const g = document.getElementById('globalNumbers').value.trim();
    if(g) params.set('g', g);
    const rules = document.getElementById('rules').value;
    if(rules) params.set('rules', rules);
    const url = `${location.origin}${location.pathname}?${params.toString()}`;
    navigator.clipboard.writeText(url).then(()=> {
      alert('Link kopiran u clipboard:\n' + url);
    }).catch(()=> {
      prompt('Kopiraj link ručno:', url);
    });
  }

  // import/export rules
  document.getElementById('fileInput').addEventListener('change', handleFileImport);
  function exportRules(){
    const data = document.getElementById('rules').value;
    const blob = new Blob([data], {type: "application/json"});
    const u = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = u;
    a.download = 'rules.json';
    a.click();
    URL.revokeObjectURL(u);
  }
  function importRules(){
    document.getElementById('fileInput').click();
  }
  function handleFileImport(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById('rules').value = ev.target.result;
    };
    reader.readAsText(file);
  }

  // Prefill from URL params if present
  (function prefillFromURL(){
    const params = new URLSearchParams(window.location.search);
    for(let i=1;i<=7;i++){
      if(params.has('p'+i)) document.getElementById('p'+i).value = params.get('p'+i);
    }
    if(params.has('g')) document.getElementById('globalNumbers').value = params.get('g');
    if(params.has('rules')) document.getElementById('rules').value = params.get('rules');
  })();

})();
</script>
</body>
</html>
